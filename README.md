# B站崩批统计排行榜 (bh3_Rank)

一个用于统计和分析B站崩坏3相关UP主视频数据的GUI应用程序。通过关键词检索视频，聚合UP主数据，生成排行榜，并支持使用LLM进行智能评价。
本项目仅供学习和研究使用，请遵守相关法律法规和网站使用条款。仅作为娱乐项目，不针对任何UP主，不真实评价任何UP主，感谢各位作业流程，如有冒犯，后续增加排除功能。
（看了下各种评价视频，有感而发的项目）

## 📋 目录

- [功能特性](#功能特性)
- [快速开始](#快速开始)
- [配置说明](#配置说明)
- [使用指南](#使用指南)
- [项目结构](#项目结构)
- [技术栈](#技术栈)
- [注意事项](#注意事项)

## ✨ 功能特性

### 核心功能
- **关键词检索**：通过自定义关键词在B站检索相关视频（使用B站公开API）
- **多线程采集**：关键词/分页检索与视频详情抓取均支持并行，显著提升采集速度
- **数据聚合**：按UP主聚合视频数据（播放量、点赞数、收藏数、视频数、简介字数等）
- **多维度排行**：支持三种榜单类型
  - 总榜：综合所有视频数据
  - 深渊榜：仅统计包含"深渊"关键词的视频
  - 战场榜：仅统计包含"记忆战场"或"战场"关键词的视频
- **时间过滤**：支持设置开始和结束日期，仅统计指定时间范围内的视频
- **CSV导出**：支持将排行榜数据导出为CSV文件
- **异常值过滤**：可选「排除异常数据」模式，支持通过 GUI 自定义标准差系数，自动剔除异常高的数据并从聚合指标中扣除

### LLM智能评价（可选）
- **多Provider支持**：
  - OpenAI API（包括兼容OpenAI API的服务，如DeepSeek等）
  - Ollama（本地部署）
  - 无LLM模式（使用本地加权评级）
- **智能评分**：LLM对UP主进行评分（1-10分）并生成评价摘要
- **权重配置**：可调整LLM评分在最终排名中的权重（0-1）
- **并发处理**：支持配置LLM并发数，提高处理效率
- **本地评级**：当LLM未启用时，使用本地加权算法进行评级
  - 评级等级：夯 > 顶级 > 人上人 > NPC > 拉完了
  - 考虑因素：视频数、播放量、点赞数、收藏数、简介字数
  - 特殊权重：包含"寂灭"/"榜一"关键词的视频可绑定不同配重
  - **权重完全自定义**：在 GUI 中通过「配置评分权重」按钮为三种场景分别设置五项权重

### 代理支持
- **代理池**：支持配置多个代理，自动轮换使用
- **ProxyPool框架**：支持从ProxyPool API自动拉取代理
- **代理测试**：内置代理测试功能，自动筛选可用代理
- **智能选择**：优先使用失败次数最少的代理

### 其他特性
- **B站Cookie支持**：可配置B站Cookie，提高请求成功率
- **配置持久化**：设置自动保存到`config.json`，下次启动自动加载（包含自定义权重、异常阈值等）
- **实时日志**：显示运行日志，方便调试和监控
- **进度显示**：实时显示采集进度
- **安全显示**：Cookie和API Key在界面中以星号显示

## 🚀 快速开始

### 环境要求
- Python 3.10+
- Windows/Linux/macOS

### 安装步骤

1. **克隆或下载项目**

2. **创建虚拟环境并安装依赖**：

```powershell
# Windows PowerShell
python -m venv .venv
.\.venv\Scripts\Activate.ps1
pip install -r requirements.txt
```

```bash
# Linux/macOS
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

3. **运行程序**：

```powershell
python app.py
```

## ⚙️ 配置说明

### 基本配置

程序首次运行后会在项目目录下生成`config.json`文件，也可以通过GUI界面的"保存设置"按钮保存配置。

### 配置项说明

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| `provider` | LLM提供商：`openai`、`ollama`、`none` | `openai` |
| `api_key` | LLM API密钥（OpenAI或兼容服务） | 空 |
| `api_url` | LLM API地址（可选，用于自定义端点） | 空 |
| `llm_model` | LLM模型名称 | `gpt-3.5-turbo` |
| `use_llm` | 是否启用LLM评价 | `true` |
| `llm_weight` | LLM评分权重（0-1） | `0.4` |
| `llm_threads` | LLM并发数 | `4` |
| `crawl_threads` | 检索并发数（关键词并行抓取） | `3` |
| `bili_cookie` | B站Cookie（提高请求成功率） | 空 |
| `proxies` | 代理列表（逗号分隔） | 空 |
| `use_proxy` | 是否启用代理池 | `false` |
| `use_proxypool` | 是否使用ProxyPool框架 | `false` |
| `weight_configs` | 自定义评分权重（常规/含寂灭/含榜一） | 见默认值 |
| `outlier_sigma` | 异常值判定的标准差系数 | `2.5` |

### LLM配置示例

#### OpenAI API
```json
{
  "provider": "openai",
  "api_key": "sk-...",
  "api_url": "",
  "llm_model": "gpt-3.5-turbo"
}
```

#### 兼容OpenAI API的服务（如DeepSeek）
```json
{
  "provider": "openai",
  "api_key": "your_api_key",
  "api_url": "https://api.deepseek.com/v1",
  "llm_model": "deepseek-chat"
}
```

#### Ollama本地部署
```json
{
  "provider": "ollama",
  "api_url": "http://localhost:11434",
  "llm_model": "llama2"
}
```

### 代理配置示例

#### 直接配置代理
```json
{
  "proxies": "http://127.0.0.1:8080,http://127.0.0.1:8081",
  "use_proxy": true
}
```

#### 使用ProxyPool框架
```json
{
  "proxies": "http://proxy-pool.example.com",
  "use_proxy": false,
  "use_proxypool": true
}
```

## 📖 使用指南

### 基本使用流程

1. **设置筛选条件**
   - 关键词：输入要检索的关键词（逗号分隔），默认包含崩坏3相关关键词
   - 开始/结束日期：设置要统计的视频发布时间范围
   - Pages/关键词：设置每个关键词检索的页数（1-10页）

2. **配置LLM（可选）**
   - 选择LLM Provider
   - 输入API Key和API URL（如需要）
   - 设置模型名称
   - 调整LLM权重和并发数
   - 点击"测试 LLM"验证连接

3. **配置代理（可选）**
   - 输入代理地址（逗号分隔）
   - 选择是否启用代理池或使用ProxyPool框架
   - 点击"测试代理"验证代理可用性

4. **配置B站Cookie（可选）**
   - 从浏览器复制B站Cookie
   - 粘贴到"B站 Cookie"输入框（显示为星号）

5. **高级设置**
   - 点击“配置评分权重”自定义三种场景的五类指标配比
   - 勾选“排除异常数据”可自动剔除异常高的数据，旁边的“阈值系数”可调节敏感度（默认 2.5σ）
   - 设置“检索并发数”可控制关键词抓取线程数

6. **开始采集**
   - 点击"开始采集并排行"按钮
   - 等待采集和排行完成
   - 可在"运行日志"中查看进度

7. **查看结果**
   - 在表格中查看排行榜
   - 切换"显示榜单"下拉框查看不同榜单（总榜/深渊榜/战场榜）
   - 点击"导出 CSV"保存结果

### 评级系统说明

#### LLM评级（启用时）
- LLM会根据UP主的视频数据（视频数、播放量、点赞数等）进行评分
- 评分范围：1-10分
- 评级等级映射：
  - 8.5分以上：夯
  - 7.0-8.5分：顶级
  - 5.5-7.0分：人上人
  - 3.5-5.5分：NPC
  - 3.5分以下：拉完了

#### 本地评级（LLM未启用时）
- 基于视频数、播放量、点赞数、收藏数、简介字数的加权评分
- 权重可在 GUI 中针对三种场景（常规/含寂灭/含榜一）独立配置
- 默认权重：
  - 常规：视频数30%，播放量30%，简介10%，收藏15%，点赞15%
  - 含“寂灭”：视频数40%，播放量30%，简介10%，收藏10%，点赞10%
  - 含“榜一”：视频数50%，播放量20%，简介10%，收藏10%，点赞10%
- 最终评分会映射到相同的评级等级

### 界面说明

- **筛选条件区域**：设置检索关键词、时间范围、页数等
- **设置区域**：配置LLM、代理、Cookie等
- **操作按钮**：开始/停止采集、导出CSV
- **排行榜表格**：显示排名、UP主名称、评级、视频数、播放量、点赞数、分数、评价
- **运行日志**：显示程序运行状态和错误信息

## 📁 项目结构

```
bh3_Rank/
├── app.py              # 主GUI应用程序
├── bilibili.py         # B站API接口封装和代理管理
├── llm_client.py       # LLM客户端（支持OpenAI和Ollama）
├── utils.py            # 工具函数
├── requirements.txt    # Python依赖
├── config.json         # 配置文件（自动生成）
├── README.md           # 项目说明文档
└── dist/               # 打包后的可执行文件（如存在）
```

## 🛠️ 技术栈

- **GUI框架**：tkinter（Python标准库）
- **HTTP请求**：requests
- **并发处理**：threading, concurrent.futures
- **数据处理**：json, csv
- **日期处理**：datetime, python-dateutil

## ⚠️ 注意事项

### 使用限制
- 本项目使用B站公开API，请遵守B站使用条款
- 建议控制请求频率，避免过于频繁的请求
- 大量采集时建议使用代理和Cookie，降低被封禁风险

### 安全提示
- Cookie和API Key在界面中以星号显示，但实际值会保存在`config.json`中
- 请妥善保管`config.json`文件，不要将其提交到公开仓库
- 建议将`config.json`添加到`.gitignore`中

### 常见问题

**Q: 遇到412错误怎么办？**  
A: 412表示请求被B站拦截。建议：
- 配置有效的B站Cookie
- 使用代理池
- 降低请求频率

**Q: LLM连接失败？**  
A: 检查：
- API Key是否正确
- API URL是否正确（Ollama需要指定完整地址）
- 网络连接是否正常
- 点击"测试 LLM"查看详细错误信息

**Q: 代理测试失败？**  
A: 检查：
- 代理地址格式是否正确（`http://ip:port`）
- 代理是否可用
- 如果使用ProxyPool，检查API端点是否正确

**Q: 如何获取B站Cookie？**  
A: 
1. 在浏览器中登录B站
2. 打开开发者工具（F12）
3. 在Network标签中找到任意请求
4. 复制请求头中的Cookie值

### 打包为可执行文件

项目包含`B站崩批统计排行榜.spec`文件，可以使用PyInstaller打包：

```powershell
pip install pyinstaller
pyinstaller B站崩批统计排行榜.spec
```

打包后的可执行文件在`dist/`目录中。

## 📝 更新日志

- 支持三种榜单类型（总榜、深渊榜、战场榜）
- 支持代理池和ProxyPool框架
- 支持LLM权重配置和并发控制
- 支持可视化配置的本地评级权重（常规/寂灭/榜一）
- 新增检索并发控制、异常数据过滤（含可调σ系数）
- 支持本地评级系统（LLM未启用时）
- 界面优化：Cookie和API Key安全显示
- 配置自动保存和加载

## 📄 许可证

本项目仅供学习和研究使用，请遵守相关法律法规和网站使用条款。仅作为娱乐项目，不针对任何UP主，不真实评价任何UP主，感谢各位作业流程，如有冒犯，后续增加排除功能。
